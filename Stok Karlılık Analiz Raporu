SELECT
    COALESCE(S.STOK_KODU, I.STOK_KODU) AS STOK_KODU,
    DBO.TRK(A.STOK_ADI) AS STOK_ADI,

    ISNULL(S.SATIS_ADET, 0) AS SATIS_ADET,
    ISNULL(I.IADE_ADET, 0) AS IADE_ADET,
    ISNULL(S.SATIS_ADET, 0) - ISNULL(I.IADE_ADET, 0) AS NET_SATIS_ADET,

  
    ISNULL(S.SATIS_TUTAR, 0) AS SATIS_TUTAR_TL,
    ISNULL(I.IADE_TUTAR, 0) AS IADE_TUTAR_TL,
    ISNULL(S.SATIS_TUTAR, 0) - ISNULL(I.IADE_TUTAR, 0) AS NET_SATIS_TL,

 
    (ISNULL(S.SATIS_ADET, 0) - ISNULL(I.IADE_ADET, 0)) 
        * ISNULL(A.ALIS_FIAT1, 0) AS MALIYET_TL,

    
    (ISNULL(S.SATIS_TUTAR, 0) - ISNULL(I.IADE_TUTAR, 0))
        - ((ISNULL(S.SATIS_ADET, 0) - ISNULL(I.IADE_ADET, 0)) * ISNULL(A.ALIS_FIAT1, 0))
        AS KAR_TL

FROM 
(
    
    SELECT  
        STOK_KODU,
        SUM(STHAR_GCMIK) AS SATIS_ADET,
        SUM(STHAR_GCMIK * STHAR_NF) AS SATIS_TUTAR
    FROM TBLSTHAR
    WHERE
        STHAR_HTUR = 'J'      
        AND STHAR_FTIRSIP = '1'
		AND MONTH(STHAR_TARIH) = '3'
       
    GROUP BY STOK_KODU
) S

FULL JOIN 
(
    
    SELECT  
        STOK_KODU,
        SUM(STHAR_GCMIK) AS IADE_ADET,
        SUM(STHAR_GCMIK * STHAR_NF) AS IADE_TUTAR
    FROM TBLSTHAR
    WHERE
        STHAR_HTUR IN ('L','M') 
        AND STHAR_FTIRSIP = '2'
		AND MONTH(STHAR_TARIH) = '3'
       
    GROUP BY STOK_KODU
) I ON S.STOK_KODU = I.STOK_KODU

LEFT JOIN TBLSTSABIT A 
    ON A.STOK_KODU = COALESCE(S.STOK_KODU, I.STOK_KODU);

